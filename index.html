<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Facility Distance Checker üîí</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f7f9;
      margin: 0;
      padding: 40px 20px;
      color: #333;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #007bff;
    }
    label { display: block; margin: 15px 0 5px; font-weight: 600; }
    input, textarea, select {
      width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc;
    }
    textarea { resize: vertical; }
    button {
      background: #007bff; color: #fff; border: none; padding: 12px 20px;
      border-radius: 8px; cursor: pointer; margin: 10px 5px 0 0; font-size: 1rem;
    }
    button:hover { background: #0056b3; }
    #results, #map { margin-top: 30px; }
    ul { list-style: none; padding: 0; }
    li { background: #f0f4f8; margin: 5px 0; padding: 10px 15px; border-radius: 8px; }
    footer { text-align: center; margin-top: 40px; color: #666; }
    #authSection, #appSection { display: none; }
    #map { height: 400px; border-radius: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Facility Distance Checker üîí</h1>

    <!-- Auth Section -->
    <div id="authSection">
      <h3>Login</h3>
      <label>Email:</label>
      <input type="email" id="email" />
      <label>Password:</label>
      <input type="password" id="password" />
      <button onclick="login()">Login</button>
    </div>

    <!-- App Section -->
    <div id="appSection">
      <button onclick="logout()">Logout</button>

      <label>Candidate ZIP or City:</label>
      <input type="text" id="candidate" value="30033" />

      <label>Select State (Optional):</label>
      <select id="stateSelect" onchange="filterByState()">
        <option value="all">All States</option>
        <option value="GA">Georgia (GA)</option>
        <option value="IN">Indiana (IN)</option>
        <option value="IL">Illinois (IL)</option>
        <option value="MI">Michigan (MI)</option>
        <option value="MN">Minnesota (MN)</option>
        <option value="WI">Wisconsin (WI)</option>
      </select>

      <label>Facilities (one per line):</label>
      <textarea id="facilities" rows="15">Alpharetta, GA
Atlanta, GA
Kennesaw, GA
Johns Creek, GA
Dalton, GA
College Park, GA
Marietta, GA
Fayetteville, GA
Stockbridge, GA
Woodstock, GA
Norcross, GA
Suwanee, GA
Roswell, GA
Buford, GA
Gainesville, GA
Columbus, GA
Austell, GA
Munster, IN 46321
Crown Point, IN 46307
Granger, IN 46530
South Bend, IN 46617
Mishawaka, IN 46544
East Peoria, IL 61611
Dunlap, IL 61525
Goshen, IN 46526
Bloomington, IL 61704
Plymouth, IN 46563
Elkhart, IN 46514
New Lenox, IL 60451
Evanston, IL 60201
Chicago, IL 60622
Flint, MI 48507
Detroit, MI 48213
Saint Clair Shores, MI 48081
New Baltimore, MI 48047
Southfield, MI 48075
Dearborn, MI 48126
East Lansing, MI 48823
Canton, MI 48187
Berkley, MI 48072
Wayzata, MN 55391
Fond du Lac, WI 54935
Appleton, WI 54911
Green Bay, WI 54311
Mauston, WI 53948
Manitowoc, WI 54220
New Berlin, WI 53151
Omro, WI 54963
Oshkosh, WI 54902
Sun Prairie, WI 53590
West Bend, WI 53095
Hopkins, MN 55343
St. Paul, MN 55102
Glendale, WI 53217
Greendale, WI 53129
Fox Point, WI 53217
Onalaska, WI 54650
Racine, WI 53406
Lake Geneva, WI 53147
Mequon, WI 53092</textarea>

      <label>Max Distance (miles):</label>
      <input type="number" id="maxDistance" value="50" />

      <button onclick="checkDistances()">Check Distances</button>
      <button onclick="downloadCSV()">Download CSV</button>

      <div id="results">
        <h3>‚úÖ Within Range</h3>
        <ul id="withinList"></ul>
        <h3>‚ùå Out of Range</h3>
        <ul id="outOfRangeList"></ul>
      </div>

      <div id="map"></div>
    </div>
  </div>

  <footer>Made with ‚ù§Ô∏è by Shaswat Pandey v.0.2</footer>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAy7IJNZFpl9Q6ljPTYN2YCDKbQw2GzGwM",
      authDomain: "facilitydistancetool.firebaseapp.com",
      projectId: "facilitydistancetool",
      storageBucket: "facilitydistancetool.appspot.com",
      messagingSenderId: "680011212791",
      appId: "1:680011212791:web:3ac830bc6d5d8cc4cc30f2",
      measurementId: "G-C06QMEMJL5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const authSection = document.getElementById('authSection');
    const appSection = document.getElementById('appSection');

    onAuthStateChanged(auth, user => {
      if (user) {
        authSection.style.display = 'none';
        appSection.style.display = 'block';
      } else {
        authSection.style.display = 'block';
        appSection.style.display = 'none';
      }
    });

    window.login = function() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      signInWithEmailAndPassword(auth, email, password)
        .then(() => alert('Login successful!'))
        .catch(err => alert(err.message));
    };

    window.logout = function() {
      signOut(auth);
    };
  </script>

  <!-- Leaflet & OpenRouteService Tool -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const apiKey = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjZiMmM2MTZhYmIwZDQ1ZmNhNDY3YzllMTQyZjY5NGM4IiwiaCI6Im11cm11cjY0In0=';
    let withinResults = [], outOfRangeResults = [], map, markersLayer;

    async function geocodeLocation(location) {
      const url = `https://api.openrouteservice.org/geocode/search?api_key=${apiKey}&text=${encodeURIComponent(location)}`;
      const response = await fetch(url);
      const data = await response.json();
      if (data.features?.length) {
        const coords = data.features[0].geometry.coordinates;
        return { lon: coords[0], lat: coords[1] };
      }
      return null;
    }

    function filterByState() {
      const selected = document.getElementById('stateSelect').value;
      const textarea = document.getElementById('facilities');
      const allLines = textarea.value.split('\n');
      if (selected === 'all') return; 
      const filtered = allLines.filter(line => line.includes(`, ${selected}`));
      textarea.value = filtered.join('\n');
    }

    async function checkDistances() {
      const candidateLoc = document.getElementById('candidate').value.trim();
      const facilities = document.getElementById('facilities').value.split('\n').map(f => f.trim()).filter(Boolean);
      const maxMiles = parseFloat(document.getElementById('maxDistance').value);
      const withinList = document.getElementById('withinList');
      const outOfRangeList = document.getElementById('outOfRangeList');
      withinList.innerHTML = '<li>‚è≥ Processing...</li>';
      outOfRangeList.innerHTML = '';

      withinResults = []; 
      outOfRangeResults = [];
      const originCoord = await geocodeLocation(candidateLoc);
      if (!originCoord) return alert('Geocode failed for candidate.');

      const coordsList = await Promise.all(facilities.map(geocodeLocation));
      const locations = [[originCoord.lon, originCoord.lat], ...coordsList.filter(Boolean).map(c => [c.lon, c.lat])];
      const body = { locations, metrics: ["distance"], units: "mi" };

      const res = await fetch('https://api.openrouteservice.org/v2/matrix/driving-car', {
        method: 'POST',
        headers: { Authorization: apiKey, 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      const matrix = await res.json();
      const distances = matrix.distances[0].slice(1);
      withinList.innerHTML = ''; 
      outOfRangeList.innerHTML = '';

      if (!map) {
        map = L.map('map').setView([originCoord.lat, originCoord.lon], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      }
      if (markersLayer) map.removeLayer(markersLayer);
      markersLayer = L.layerGroup().addTo(map);

      L.marker([originCoord.lat, originCoord.lon]).addTo(markersLayer).bindPopup(`Candidate: ${candidateLoc}`).openPopup();

      facilities.forEach((fac, i) => {
        const coords = coordsList[i];
        const dist = distances[i];
        if (coords && dist <= maxMiles) {
          withinResults.push({ facility: fac, distance: dist.toFixed(1) });
        } else {
          outOfRangeResults.push({ facility: fac, distance: dist?.toFixed(1) || 'N/A' });
        }
      });

      // ‚úÖ Sort ascending by distance
      withinResults.sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance));
      outOfRangeResults.sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance));

      withinResults.forEach(r => {
        withinList.innerHTML += `<li>${r.facility}: ${r.distance} mi ‚úÖ</li>`;
      });
      outOfRangeResults.forEach(r => {
        outOfRangeList.innerHTML += `<li>${r.facility}: ${r.distance} mi ‚ùå</li>`;
      });

      map.fitBounds(markersLayer.getBounds());
    }

    function downloadCSV() {
      let csv = 'Facility,Distance (mi),Status\n';
      withinResults.forEach(r => csv += `"${r.facility}",${r.distance},Within Range\n`);
      outOfRangeResults.forEach(r => csv += `"${r.facility}",${r.distance},Out of Range\n`);
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'facility_distances.csv';
      a.click();
    }
  </script>
</body>
</html>

